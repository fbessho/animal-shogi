<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Animal Shogi</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  </head>
  <body>
    <div id="board"></div>
    <script>
        var width = 133, height = 133, span=10;
        var rows = 4, cols=3;
        var initial = [
            {y: 4, x: 1, piece: "Elephant", mine: true},
            {y: 4, x: 2, piece: "Lion",     mine: true},
            {y: 4, x: 3, piece: "Giraffe",  mine: true},
            {y: 3, x: 2, piece: "Chick",    mine: true},
            {y: 2, x: 2, piece: "Chick",    mine: false},
            {y: 1, x: 1, piece: "Giraffe",  mine: false},
            {y: 1, x: 2, piece: "Lion",     mine: false},
            {y: 1, x: 3, piece: "Elephant", mine: false}
        ];


        var svg = d3.select("#board").append("svg");
        svg.attr("width", width * cols + span * (cols+1))
            .attr("height", height * rows + span * (rows+1));

        var pieces = svg.selectAll("image")
            .data(initial)
            .enter()
            .append("g")
            .attr("transform", function(d){
                var x = width * (d.x - 0.5) + span * d.x;
                var y = height * (d.y - 0.5) + span * d.y;
                return "translate(" + x + "," + y + ")";
            })
            .call(d3.drag().on("drag", dragged).on("end", dropped))
            .append("image")
            .attr("xlink:href", function(d){return "img/" + d.piece + ".png";})
            .attr("x", -0.5*width)
            .attr("y", -0.5*height)
            .attr("height", height)
            .attr("width", width)
            .attr("transform", function(d){ if(!d.mine) return "rotate(180)";});


        function dragged() {
            var thisObject = d3.select(this);
            var t = getTranslation(thisObject.attr("transform"));
            var x = t[0] + d3.event.dx;
            var y = t[1] + d3.event.dy;
            d3.select(this).attr("transform", function(d){
                return "translate(" + [x, y] + ")"
            })
        }

        function dropped() {
          // TODO implement
        }

        // https://stackoverflow.com/a/38230545/870658
        function getTranslation(transform) {
          // Create a dummy g for calculation purposes only. This will never
          // be appended to the DOM and will be discarded once this function
          // returns.
          var g = document.createElementNS("http://www.w3.org/2000/svg", "g");

          // Set the transform attribute to the provided string value.
          g.setAttributeNS(null, "transform", transform);

          // consolidate the SVGTransformList containing all transformations
          // to a single SVGTransform of type SVG_TRANSFORM_MATRIX and get
          // its SVGMatrix.
          var matrix = g.transform.baseVal.consolidate().matrix;

          // As per definition values e and f are the ones for the translation.
          return [matrix.e, matrix.f];
        }

    </script>
  </body>
</html>